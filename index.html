<!-- Dependências (Tailwind + FontAwesome + HTML2PDF) -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<!-- ÍCONES -->
<link rel="icon" href="https://gesseiromaster.site/wp-content/uploads/2025/12/spatula-svgrepo-com.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="https://gesseiromaster.site/wp-content/uploads/2025/12/spatula-svgrepo-com.svg">

<!-- MANIFESTO PWA EMBUTIDO -->
<link rel="manifest" id="my-manifest">
<script>
    try {
        const manifest = {
            "name": "Calculadora do Gesseiro",
            "short_name": "GessoCalc",
            "start_url": window.location.href.split('?')[0], // Garante URL limpa no início
            "display": "standalone",
            "background_color": "#F8FAFC",
            "theme_color": "#0F172A",
            "orientation": "portrait",
            "icons": [{ "src": "https://gesseiromaster.site/wp-content/uploads/2025/12/spatula-svgrepo-com.svg", "sizes": "any", "type": "image/svg+xml" }]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        const linkTag = document.querySelector('#my-manifest');
        if(linkTag) linkTag.setAttribute('href', manifestURL);
    } catch(e) { console.log('Manifest config error ignored'); }
</script>

<!-- CONFIGURAÇÃO DE APP -->
<meta name="theme-color" content="#0F172A">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Calculadora do Gesseiro">

<!-- Configuração do Tailwind -->
<script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: { sans: ['Poppins', 'sans-serif'] },
                colors: {
                    brand: '#0F172A',
                    brandLight: '#334155',
                    detail: '#3B82F6',
                    bgPage: '#F8FAFC',
                },
                boxShadow: {
                    'soft': '0 10px 30px -10px rgba(0,0,0,0.08)',
                }
            }
        },
        corePlugins: { preflight: false }
    }
</script>

<style>
    /* Reset e Estrutura App-Like */
    html, body { overscroll-behavior-y: none; }

    #gesso-app-wrapper {
        background-color: #F8FAFC;
        color: #0F172A;
        font-family: 'Poppins', sans-serif;
        width: 100%;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }

    #gesso-app-wrapper .custom-input {
        background-color: #FFFFFF;
        border: 1px solid #E2E8F0;
        color: #0F172A;
        padding: 16px 16px 16px 52px;
        border-radius: 14px;
        width: 100%;
        font-size: 15px;
        font-weight: 500;
        transition: all 0.2s ease;
        line-height: normal;
    }

    #gesso-app-wrapper .custom-input:focus { outline: none; border-color: #3B82F6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
    #gesso-app-wrapper .input-group { position: relative; margin-bottom: 0.75rem; }
    
    #gesso-app-wrapper .input-icon { 
        position: absolute; left: 18px; top: 50%; transform: translateY(-50%); 
        color: #94A3B8; font-size: 18px; pointer-events: none; transition: color 0.3s; 
        z-index: 10; display: flex; align-items: center;
    }
    
    #gesso-app-wrapper .custom-input:focus + .input-icon, 
    #gesso-app-wrapper .custom-input:focus ~ .input-icon { color: #3B82F6; }
    
    #gesso-app-wrapper .field-label { display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748B; margin-bottom: 6px; font-weight: 700; }
    
    #gesso-app-wrapper .clean-card {
        background: #FFFFFF;
        border-radius: 20px;
        box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.03);
        border: 1px solid #F1F5F9;
    }

    @keyframes slideUpElem { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-up { animation: slideUpElem 0.5s cubic-bezier(0.16, 1, 0.3, 1); }

    #pdf-wrapper { position: absolute; top: 0; left: -9999px; width: 100%; z-index: -100; visibility: hidden; }
    #pdf-template { width: 210mm; background: white; margin: 0 auto; }
    
    #gesso-app-wrapper button { box-sizing: border-box; }
    .no-scroll { overflow: hidden; height: 100vh; }
    
    .icon-filter-white { filter: invert(1) brightness(200%); }

    /* Custom Toast & Modal Styles */
    #toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 90%;
        max-width: 350px;
        pointer-events: none;
    }
    .custom-toast {
        background: #1e293b;
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideDownToast 0.3s ease-out;
        pointer-events: auto;
    }
    .custom-toast.error { background: #ef4444; }
    .custom-toast i { font-size: 16px; }
    @keyframes slideDownToast { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

    #confirm-modal-overlay, #materials-modal-overlay {
        position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); z-index: 10001;
        display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    #confirm-modal-content, #materials-modal-content {
        background: white; width: 90%; max-width: 400px; padding: 24px; border-radius: 24px;
        box-shadow: 0 20px 40px -5px rgba(0,0,0,0.2); text-align: center;
        transform: scale(0.9); transition: transform 0.2s; max-height: 85vh; display: flex; flex-direction: column;
    }
    #confirm-modal-overlay.active, #materials-modal-overlay.active { display: flex; }
    #confirm-modal-overlay.active #confirm-modal-content, #materials-modal-overlay.active #materials-modal-content { transform: scale(1); }
</style>

<!-- Container de Toasts -->
<div id="toast-container"></div>

<!-- Modal de Confirmação -->
<div id="confirm-modal-overlay">
    <div id="confirm-modal-content">
        <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center mx-auto mb-4 text-xl">
            <i class="fa-solid fa-circle-question"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-800 mb-2">Confirmação</h3>
        <p id="confirm-modal-text" class="text-slate-500 text-sm mb-6">Tem certeza?</p>
        <div class="flex gap-3">
            <button id="btn-cancel-modal" class="flex-1 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold text-sm">Cancelar</button>
            <button id="btn-confirm-modal" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold text-sm shadow-lg shadow-blue-200">Confirmar</button>
        </div>
    </div>
</div>

<!-- Modal de Lista de Materiais -->
<div id="materials-modal-overlay">
    <div id="materials-modal-content" class="text-left">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-boxes-stacked text-detail"></i> Materiais
            </h3>
            <button onclick="fecharMateriais()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        
        <div class="bg-blue-50 p-3 rounded-xl text-[11px] text-blue-700 mb-4 border border-blue-100">
            <i class="fa-solid fa-circle-info mr-1"></i> Estimativa baseada em padrões médios de consumo (perda ~5%). Verifique na obra.
        </div>

        <div id="materials-list-body" class="overflow-y-auto flex-1 pr-1 space-y-2 mb-4 custom-scrollbar">
            <!-- Lista injetada via JS -->
        </div>

        <button onclick="copiarMateriais()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 text-sm">
            <i class="fa-regular fa-copy"></i> Copiar Lista
        </button>
    </div>
</div>

<div id="gesso-app-wrapper" onload="safeLoadPreferences()">
    
    <!-- CONTAINER PRINCIPAL -->
    <div id="appContainer" class="pb-10">
        <!-- Header -->
        <header class="relative w-full bg-brand z-10 border-b border-slate-800 shadow-md">
            <div class="max-w-md mx-auto px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <!-- ÍCONE SVG ATUALIZADO -->
                    <div class="w-11 h-11 rounded-2xl flex items-center justify-center overflow-hidden shadow-lg border border-blue-500/30 bg-blue-500/10">
                        <img src="https://gesseiromaster.site/wp-content/uploads/2025/12/spatula-svgrepo-com.svg" class="w-6 h-6 icon-filter-white object-contain" alt="GessoMaster Logo">
                    </div>
                    <div>
                        <h1 class="text-xl font-extrabold text-white tracking-tight leading-none m-0">
                            GESSO<span class="text-detail">MASTER</span>
                        </h1>
                        <span class="text-[10px] text-slate-400 font-bold tracking-widest uppercase">Orçamentos</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="abrirHistorico()" class="bg-white/10 hover:bg-white/20 text-slate-300 p-2.5 rounded-xl transition-all border border-white/5 active:scale-95" title="Histórico"><i class="fa-solid fa-clock-rotate-left"></i></button>
                    <button type="button" onclick="abrirConfig()" class="bg-white/10 hover:bg-white/20 text-slate-300 p-2.5 rounded-xl transition-all border border-white/5 active:scale-95" title="Configurações"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>
        </header>

        <!-- Main Form -->
        <div class="max-w-md mx-auto px-5 pt-6 space-y-6">
            <form id="calcForm" onsubmit="event.preventDefault(); calcularOrcamento();">
                
                <!-- 1. Dados -->
                <div class="clean-card p-6 animate-slide-up">
                    <div class="flex items-center gap-3 mb-6 pb-3 border-b border-slate-50">
                        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-detail">
                            <i class="fa-solid fa-address-card text-xl"></i>
                        </div>
                        <h2 class="text-lg font-bold text-brand m-0">Dados Gerais</h2>
                    </div>
                    <div class="space-y-4">
                        <div><label class="field-label">Nome do Cliente</label><div class="input-group"><input type="text" id="clientName" placeholder="Ex: Maria Silva" class="custom-input" required><i class="fa-regular fa-user input-icon"></i></div></div>
                        <div class="grid grid-cols-1 gap-4">
                            <div><label class="field-label">WhatsApp</label><div class="input-group"><input type="tel" id="clientPhone" placeholder="(00) 00000-0000" class="custom-input"><i class="fa-brands fa-whatsapp input-icon"></i></div></div>
                            <div><label class="field-label">Endereço da Obra</label><div class="input-group"><input type="text" id="clientAddress" placeholder="Bairro, Rua..." class="custom-input"><i class="fa-solid fa-location-dot input-icon"></i></div></div>
                        </div>
                    </div>
                </div>

                <!-- 2. Serviços -->
                <div class="clean-card p-6 animate-slide-up" style="animation-delay: 0.1s;">
                    <!-- ... existing service card content ... -->
                    <div class="flex items-center gap-3 mb-6 pb-3 border-b border-slate-50">
                        <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600">
                            <i class="fa-solid fa-screwdriver-wrench text-xl"></i>
                        </div>
                        <h2 class="text-lg font-bold text-brand m-0">Serviços</h2>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 mb-5">
                        <!-- NOVO DESIGN DOS BOTÕES DE SELEÇÃO -->
                        <div class="flex bg-slate-200/60 p-1.5 rounded-2xl gap-1 mb-5">
                            <button type="button" onclick="toggleServiceTab('catalogo')" id="tabCatalogo" class="flex-1 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm bg-white text-brand border border-slate-200">
                                <i class="fa-solid fa-book-open mr-1"></i> Catálogo
                            </button>
                            <button type="button" onclick="toggleServiceTab('custom')" id="tabCustom" class="flex-1 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-200/50">
                                <i class="fa-solid fa-pen-to-square mr-1"></i> Item Avulso
                            </button>
                        </div>

                        <!-- CATÁLOGO -->
                        <div id="blockCatalogo">
                            <div class="space-y-4">
                                <div>
                                    <label class="field-label">Selecione o Serviço</label>
                                    <div class="input-group">
                                        <select id="serviceTypeInput" class="custom-input appearance-none cursor-pointer text-sm !bg-white">
                                            <optgroup label="Sistemas Plaquinha 60x60">
                                                <option value="Forro Plaquinha">Forro Plaquinha 60x60 Liso</option>
                                                <option value="Forro Plaquinha Decorado">Forro Plaquinha Decorado</option>
                                                <option value="Forro Plaquinha Dilatado">Forro Plaquinha c/ Dilatação</option>
                                                <option value="Forro Aramado">Forro Aramado (Gesso Liso)</option>
                                                <option value="Fechamento de Beiral">Fechamento de Beiral</option>
                                                <option value="Revestimento de Parede">Revestimento de Parede</option>
                                                <option value="Revestimento 3D">Revestimento 3D</option>
                                                <option value="Moldura de Gesso">Moldura de Gesso (Metro)</option>
                                                <option value="Sanca Aberta Gesso">Sanca Aberta (Gesso)</option>
                                                <option value="Sanca Fechada Gesso">Sanca Fechada (Gesso)</option>
                                                <option value="Cortineiro Gesso">Cortineiro (Gesso)</option>
                                            </optgroup>
                                            <optgroup label="Sistemas Drywall">
                                                <option value="Forro Drywall">Forro Drywall Liso (F530)</option>
                                                <option value="Forro Drywall Tabicado">Forro Drywall Tabicado</option>
                                                <option value="Forro Drywall Acústico">Forro Drywall Acústico</option>
                                                <option value="Forro Drywall Aramado">Forro Drywall Estruturado</option>
                                                <option value="Parede Drywall">Parede Drywall Simples</option>
                                                <option value="Parede Drywall Acústica">Parede Drywall Acústica</option>
                                                <option value="Parede Drywall RU">Parede Drywall RU (Umidade)</option>
                                                <option value="Parede Drywall RF">Parede Drywall RF (Fogo)</option>
                                                <option value="Revestimento Drywall">Revestimento Drywall</option>
                                                <option value="Shaft Drywall">Shaft</option>
                                                <option value="Closet Drywall">Closet / Prateleiras</option>
                                            </optgroup>
                                            <!-- NOVO GRUPO PVC -->
                                            <optgroup label="Sistemas Forro PVC">
                                                <option value="Forro PVC Branco Liso 8mm">Forro PVC Branco Liso 8mm</option>
                                                <option value="Forro PVC Branco Frisado 8mm">Forro PVC Branco Frisado 8mm</option>
                                                <option value="Forro PVC Branco Liso 10mm">Forro PVC Branco Liso 10mm</option>
                                                <option value="Forro PVC Branco Frisado 10mm">Forro PVC Branco Frisado 10mm</option>
                                                <option value="Forro PVC Madeirado Carvalho">Forro PVC Madeirado Carvalho</option>
                                                <option value="Forro PVC Madeirado Cerejeira">Forro PVC Madeirado Cerejeira</option>
                                                <option value="Forro PVC Madeirado Mogno">Forro PVC Madeirado Mogno</option>
                                                <option value="Forro PVC Madeirado Nogueira">Forro PVC Madeirado Nogueira</option>
                                                <option value="Forro PVC Decorado 3D">Forro PVC Decorado 3D</option>
                                                <option value="Forro PVC Preto Liso">Forro PVC Preto Liso</option>
                                                <option value="Forro PVC Preto Frisado">Forro PVC Preto Frisado</option>
                                                <option value="Forro PVC Cinza/Prata">Forro PVC Cinza/Prata</option>
                                                <option value="Forro PVC Texturizado">Forro PVC Texturizado</option>
                                                <option value="Forro PVC Térmico (c/ Isopor)">Forro PVC Térmico (c/ Isopor)</option>
                                                <option value="Forro PVC Térmico (c/ Manta)">Forro PVC Térmico (c/ Manta)</option>
                                                <option value="Revestimento Parede PVC">Revestimento Parede PVC</option>
                                                <option value="Sanca de PVC">Sanca de PVC (Metro)</option>
                                            </optgroup>
                                            <optgroup label="Decorações">
                                                <option value="Sanca Ilha">Sanca Ilha</option>
                                                <option value="Sanca Invertida">Sanca Invertida</option>
                                                <option value="Rasgo de Luz">Rasgo de Luz</option>
                                                <option value="Cortineiro Embutido">Cortineiro Embutido</option>
                                                <option value="Cortineiro Sobreposto">Cortineiro Sobreposto</option>
                                                <option value="Nicho Embutido">Nicho Embutido</option>
                                                <option value="Painel de TV 3D">Painel de TV 3D</option>
                                                <option value="Cabeceira 3D">Cabeceira 3D</option>
                                                <option value="Boiserie">Boiserie</option>
                                                <option value="Rodateto Decorado">Rodateto Decorado</option>
                                            </optgroup>
                                            <!-- Grupo para serviços customizados -->
                                            <optgroup id="customServicesOptGroup" label="Meus Serviços Salvos"></optgroup>
                                        </select>
                                        <i class="fa-solid fa-chevron-down input-icon !text-xs !left-auto !right-4 !text-slate-400"></i>
                                        <i class="fa-solid fa-list-check input-icon"></i>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 gap-4">
                                    <div>
                                        <label class="field-label">Metragem / Quantidade</label>
                                        <div class="flex gap-2">
                                            <div class="input-group flex-1">
                                                <input type="number" id="areaInput" placeholder="0" min="0.1" step="0.1" class="custom-input font-bold text-lg text-brand">
                                                <i class="fa-solid fa-ruler-combined input-icon"></i>
                                            </div>
                                            <!-- SELETOR DE UNIDADE NOVO -->
                                            <div class="w-24">
                                                <div class="input-group h-full">
                                                    <select id="unitInput" class="custom-input !px-2 text-center font-bold text-slate-600 h-full !py-0 cursor-pointer">
                                                        <option value="m²">m²</option>
                                                        <option value="m">m</option>
                                                        <option value="un">un</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="field-label text-detail">Preço Manual (Opcional)</label>
                                        <div class="input-group">
                                            <input type="number" id="customRateInput" placeholder="Usar Tabela" min="0" step="0.01" class="custom-input font-bold text-lg text-detail border-blue-100">
                                            <span class="input-icon text-detail font-bold text-sm not-italic flex items-center justify-center">R$</span>
                                        </div>
                                        <p class="text-[10px] text-slate-400 mt-1 text-right">*Deixe vazio para usar o preço da Tabela</p>
                                    </div>
                                </div>

                                <button type="button" onclick="adicionarServico()" class="w-full bg-brand hover:bg-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-slate-200 active:scale-95 transition-all flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                                    <i class="fa-solid fa-circle-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>

                        <!-- MANUAL -->
                        <div id="blockCustom" class="hidden">
                            <div class="space-y-4">
                                <div>
                                    <label class="field-label">Descrição do Serviço</label>
                                    <div class="input-group">
                                        <input type="text" id="customNameInput" placeholder="Ex: Instalação Lustre" class="custom-input">
                                        <i class="fa-solid fa-pen-to-square input-icon"></i>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="field-label text-detail">Valor Total (R$)</label>
                                    <div class="flex gap-3">
                                        <div class="input-group flex-1">
                                            <input type="number" id="customPriceInput" placeholder="0,00" min="0" step="0.01" class="custom-input font-bold text-lg text-detail">
                                            <i class="fa-solid fa-tag input-icon text-detail"></i>
                                        </div>
                                        <button type="button" onclick="adicionarPersonalizado()" class="bg-detail hover:bg-blue-700 text-white font-bold px-6 rounded-xl shadow-lg active:scale-95 transition-all">
                                            <i class="fa-solid fa-plus text-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="servicesListContainer" class="hidden animate-slide-up">
                        <div class="flex justify-between items-end mb-3 px-1">
                            <label class="field-label mb-0">Lista de Itens</label>
                            <span id="totalAreaDisplay" class="text-[10px] font-bold text-white bg-detail px-2 py-1 rounded-lg"></span>
                        </div>
                        <div id="servicesList" class="space-y-3 max-h-60 overflow-y-auto pr-1"></div>
                    </div>
                </div>

                <!-- 3. Custos (Simplificado) -->
                <div class="clean-card p-6 animate-slide-up" style="animation-delay: 0.2s;">
                    <div class="flex items-center gap-3 mb-6 pb-3 border-b border-slate-50">
                        <div class="w-10 h-10 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600">
                            <i class="fa-solid fa-hand-holding-dollar text-xl"></i>
                        </div>
                        <h2 class="text-lg font-bold text-brand m-0">Custos Extras</h2>
                    </div>
                    
                    <div class="mb-2">
                        <label class="field-label text-yellow-700">Gastos Totais (Opcional)</label>
                        <div class="input-group">
                            <input type="number" id="totalExtraCost" placeholder="0,00" class="custom-input !p-4 !pl-12 text-lg font-mono text-yellow-700 border-yellow-200 focus:border-yellow-500">
                            <i class="fa-solid fa-sack-xmark input-icon text-yellow-600"></i>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2">Este valor será subtraído da venda para mostrar seu lucro real. (Ex: Ajudante, Transporte, Material Extra)</p>
                    </div>
                </div>

                <!-- Botão CALCULAR -->
                <div class="mt-8 mb-6 pb-10">
                    <button type="submit" class="w-full bg-brand hover:bg-slate-800 text-white font-bold py-4 rounded-2xl shadow-xl shadow-slate-200 transition-all active:scale-95 flex items-center justify-center gap-3 text-lg border border-slate-900 tracking-wide">
                        <i class="fa-solid fa-calculator"></i> CALCULAR TOTAL
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- DASHBOARD RESULTADOS -->
    <div id="resultsDashboard" class="hidden fixed inset-0 z-[9999] bg-[#F8FAFC] overflow-y-auto animate-slide-up w-full h-full">
        <div class="max-w-md mx-auto p-6 min-h-screen flex flex-col">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-brand tracking-tight m-0">Resultado</h2>
                <div class="flex gap-2">
                    <span class="text-xs text-green-600 font-bold bg-green-50 border border-green-100 px-3 py-2 rounded-xl flex items-center gap-1">
                        <i class="fa-solid fa-check"></i> Salvo
                    </span>
                    <button type="button" onclick="fecharResultados()" class="bg-white hover:bg-slate-50 text-slate-400 hover:text-slate-600 rounded-full p-2 w-10 h-10 flex items-center justify-center transition-colors shadow-sm border border-slate-100">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>

            <div class="space-y-4 mb-4">
                <!-- Card Valor Final -->
                <div class="bg-brand p-8 rounded-3xl shadow-soft relative overflow-hidden text-white">
                    <div class="absolute -right-6 -top-6 text-white/5 text-[9rem]"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 relative z-10">Total a Cobrar</p>
                    <div class="text-5xl font-black tracking-tight relative z-10" id="displayClientPrice">R$ 0,00</div>
                    <p class="text-slate-400 text-[10px] mt-2 relative z-10 font-medium opacity-80">Valor final de venda</p>
                </div>

                <!-- BOTÃO ESTIMATIVA MATERIAL NOVO -->
                <button onclick="abrirMateriais()" class="w-full bg-white hover:bg-slate-50 border border-slate-200 text-slate-700 font-bold py-3.5 rounded-2xl shadow-sm flex items-center justify-center gap-2 transition-all active:scale-95">
                    <i class="fa-solid fa-boxes-stacked text-detail"></i> Ver Lista de Materiais
                </button>

                <!-- CARD LUCRO -->
                <div class="clean-card p-6 border-l-4 border-detail">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <p class="text-detail text-xs font-bold uppercase mb-1">Lucro Líquido</p>
                            <div class="text-3xl font-bold text-brand" id="displayProfit">R$ 0,00</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-2xl text-detail">
                            <i class="fa-solid fa-wallet text-2xl"></i>
                        </div>
                    </div>
                    <div class="border-t border-slate-100 pt-3 mt-1 space-y-2">
                        <p class="text-xs text-slate-500 flex justify-between items-center">
                            <span><i class="fa-solid fa-circle-plus text-emerald-500 text-[8px] mr-1"></i> Venda Total:</span> 
                            <span id="detailSale" class="text-slate-700 font-mono font-bold">R$ 0,00</span>
                        </p>
                        <!-- LINHA DE DESCONTO NO DETALHE (HIDDEN BY DEFAULT) -->
                        <p id="detailDiscount" class="text-xs text-slate-500 flex justify-between items-center hidden">
                            <span><i class="fa-solid fa-tag text-orange-500 text-[8px] mr-1"></i> Desconto:</span> 
                            <span id="detailDiscountValue" class="text-orange-500 font-mono font-bold">- R$ 0,00</span>
                        </p>
                        <p class="text-xs text-slate-500 flex justify-between items-center">
                            <span><i class="fa-solid fa-circle-minus text-red-400 text-[8px] mr-1"></i> Gastos Informados:</span> 
                            <span id="detailCost" class="text-red-500 font-mono font-bold">R$ 0,00</span>
                        </p>
                        <div class="border-t border-slate-100 pt-1"></div>
                        <p class="text-xs text-blue-600 flex justify-between items-center font-bold">
                            <span><i class="fa-solid fa-equals text-blue-500 text-[8px] mr-1"></i> Saldo Final:</span> 
                            <span id="detailProfitFinal" class="text-blue-600 font-mono">R$ 0,00</span>
                        </p>
                    </div>
                </div>

                <!-- CARD INPUT DESCONTO (NOVO) -->
                <div class="clean-card p-4 mt-2 flex items-center justify-between border-l-4 border-orange-400 animate-slide-up" style="animation-delay: 0.1s;">
                    <label class="font-bold text-slate-600 text-sm flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center text-xs">
                            <i class="fa-solid fa-percent"></i>
                        </div>
                        Aplicar Desconto
                    </label>
                    <div class="flex items-center gap-2">
                        <span class="text-slate-400 text-xs font-bold">- R$</span>
                        <input type="number" id="discountInput" placeholder="0.00" class="bg-slate-50 border border-slate-200 rounded-lg p-2.5 w-28 text-right font-bold text-orange-600 focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-100 transition-all" oninput="aplicarDesconto()">
                    </div>
                </div>

                <!-- CARD INPUT OBSERVAÇÕES (NOVO) -->
                <div class="clean-card p-4 mt-2 border-l-4 border-slate-400 animate-slide-up" style="animation-delay: 0.15s;">
                    <label class="font-bold text-slate-600 text-sm flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs">
                            <i class="fa-solid fa-pen-clip"></i>
                        </div>
                        Observações / Resumo
                    </label>
                    <textarea id="projectSummaryInput" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm text-slate-600 focus:outline-none focus:border-slate-400 transition-all resize-none" rows="2" placeholder="Este orçamento inclui fornecimento de material e mão de obra especializada."></textarea>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="bg-brand p-6 rounded-3xl shadow-xl mt-6 relative overflow-hidden">
                <div class="absolute -right-6 -bottom-6 text-white/5 text-[8rem] pointer-events-none">
                    <i class="fa-solid fa-share-nodes"></i>
                </div>

                <div class="space-y-3 relative z-10">
                    <button onclick="enviarWhatsApp()" class="w-full bg-[#25D366] hover:bg-[#1ebc57] text-white font-bold py-4 rounded-2xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-3 text-lg border border-green-500">
                        <i class="fa-brands fa-whatsapp text-2xl"></i> 
                        Enviar no WhatsApp
                    </button>

                    <button onclick="gerarPDF()" class="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-4 rounded-2xl border border-white/10 transition-all active:scale-95 flex items-center justify-center gap-3 backdrop-blur-sm shadow-sm">
                        <i class="fa-solid fa-file-pdf text-red-400 text-xl"></i> 
                        Gerar PDF
                    </button>
                    
                    <button onclick="window.location.reload()" class="w-full bg-white/5 hover:bg-white/10 text-slate-300 hover:text-white font-bold py-4 rounded-2xl border border-white/5 transition-all active:scale-95 flex items-center justify-center gap-3 backdrop-blur-sm">
                        <i class="fa-solid fa-rotate-right text-lg"></i>
                        Fazer Novo Orçamento
                    </button>

                    <button onclick="fecharResultados()" class="w-full bg-detail hover:bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-900/20 transition-all active:scale-95 flex items-center justify-center gap-3 text-lg border border-blue-500/50">
                        <i class="fa-solid fa-pen-to-square"></i>
                        Voltar e Editar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONFIGURAÇÕES -->
    <div id="configModal" class="hidden fixed inset-0 z-[9999] bg-[#F8FAFC] overflow-y-auto w-full h-full">
        <div class="max-w-md mx-auto p-6 min-h-screen">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold text-brand flex items-center gap-2 m-0">
                    <i class="fa-solid fa-gear text-detail"></i> Configurações
                </h2>
                <button type="button" onclick="fecharConfig()" class="bg-white hover:bg-slate-50 rounded-full p-2 w-10 h-10 flex items-center justify-center transition-colors shadow-sm border border-slate-100">
                    <i class="fa-solid fa-check text-emerald-500"></i>
                </button>
            </div>

            <div class="clean-card p-6 mb-6">
                <div class="flex items-center gap-3 mb-6 pb-3 border-b border-slate-50">
                    <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-detail">
                        <i class="fa-solid fa-building text-sm"></i>
                    </div>
                    <h3 class="text-sm font-bold text-brand m-0">Sua Empresa</h3>
                </div>
                
                <div class="mb-6">
                    <label class="field-label">Logo da Empresa (Opcional)</label>
                    <div class="flex items-center gap-4">
                        <div id="logoPreview" class="w-16 h-16 rounded-xl bg-slate-100 border border-slate-200 flex items-center justify-center overflow-hidden">
                            <i class="fa-regular fa-image text-slate-300 text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="companyLogoInput" accept="image/*" class="hidden" onchange="handleLogoUpload(this)">
                            <button type="button" onclick="document.getElementById('companyLogoInput').click()" class="bg-white border border-slate-200 text-slate-600 font-bold py-2 px-4 rounded-lg text-xs hover:bg-slate-50 transition-all shadow-sm">
                                <i class="fa-solid fa-upload mr-1"></i> Escolher Imagem
                            </button>
                            <button type="button" onclick="removerLogo()" id="btnRemoveLogo" class="hidden text-red-400 text-[10px] font-bold mt-2 hover:text-red-500">
                                Remover Logo
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="field-label">Nome Fantasia</label>
                    <div class="input-group">
                        <input type="text" id="companyName" placeholder="Ex: Gesso Silva" class="custom-input">
                        <i class="fa-solid fa-briefcase input-icon"></i>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="field-label">Margem de Lucro (Backup)</label>
                    <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <input type="range" id="profitMargin" min="0" max="100" value="40" 
                               class="flex-grow h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-detail"
                               oninput="document.getElementById('profitDisplayConfig').innerText = this.value + '%'">
                        <span class="text-brand font-bold" id="profitDisplayConfig">40%</span>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2">Usada apenas para serviços onde você não definiu um preço fixo na tabela abaixo.</p>
                </div>

                <div class="mt-8">
                    <div class="flex items-center gap-3 mb-4 pb-2 border-b border-slate-100">
                        <div class="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600">
                            <i class="fa-solid fa-tags text-sm"></i>
                        </div>
                        <h3 class="text-sm font-bold text-brand m-0">Tabela de Preços (Venda)</h3>
                    </div>
                    
                    <p class="text-[11px] text-slate-500 mb-4 bg-slate-100 p-3 rounded-lg border border-slate-200">
                        <i class="fa-solid fa-circle-info mr-1"></i> Defina quanto você cobra por m², metro linear ou unidade.
                    </p>
                    <div class="grid grid-cols-1 gap-2 max-h-[50vh] overflow-y-auto pr-2" id="servicePriceTable"></div>
                </div>

                <!-- NOVA CAIXA DE ADICIONAR SERVIÇOS CUSTOMIZADOS -->
                <div class="mt-6 border-t border-slate-100 pt-6">
                    <h3 class="text-sm font-bold text-brand mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-plus-circle text-detail"></i> Cadastrar Novo Serviço
                    </h3>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Nome do Serviço</label>
                            <input type="text" id="newServiceName" class="custom-input !py-2 !text-sm !h-10" placeholder="Ex: Nicho Iluminado">
                        </div>
                        <div class="flex gap-2">
                            <div class="w-1/3">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Unidade</label>
                                <select id="newServiceUnit" class="custom-input !py-2 !text-sm !h-10 !px-2">
                                    <option value="m²">m²</option>
                                    <option value="m">m</option>
                                    <option value="un">un</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Preço (R$)</label>
                                <input type="number" id="newServicePrice" class="custom-input !py-2 !text-sm !h-10" placeholder="0.00">
                            </div>
                        </div>
                        <button type="button" onclick="adicionarServicoCustomizado()" class="w-full bg-brand text-white font-bold py-2 rounded-lg text-xs shadow-md mt-2 active:scale-95 transition-all">
                            SALVAR NOVO SERVIÇO
                        </button>
                    </div>
                </div>

                <!-- ÁREA DE SISTEMA E ATUALIZAÇÃO -->
                <div class="mt-8 border-t border-slate-100 pt-6">
                    <div class="flex items-center gap-3 mb-4 pb-2 border-b border-slate-100">
                        <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-600">
                            <i class="fa-solid fa-mobile-screen text-sm"></i>
                        </div>
                        <h3 class="text-sm font-bold text-brand m-0">Sistema do App</h3>
                    </div>
                    
                    <button type="button" onclick="verificarAtualizacao()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 mb-2">
                        <i class="fa-solid fa-rotate"></i> Buscar Atualização / Recarregar
                    </button>
                    <p class="text-[10px] text-center text-slate-400">Versão instalada: <span id="appVersionDisplay">Checking...</span></p>
                </div>
            </div>

            <input type="hidden" id="priceSheet" value="38.00"><input type="hidden" id="priceProfile" value="18.00"><input type="hidden" id="priceScrew" value="15.00"><input type="hidden" id="priceCompound" value="45.00"><input type="hidden" id="priceTape" value="25.00"><input type="hidden" id="pricePlaque" value="3.50"><input type="hidden" id="pricePlasterBag" value="28.00"><input type="hidden" id="priceWire" value="18.00"><input type="hidden" id="priceSisal" value="12.00">

            <button type="button" onclick="savePreferences(); fecharConfig();" class="w-full bg-brand hover:bg-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all mb-10">
                Salvar Configurações
            </button>
        </div>
    </div>

    <!-- HISTÓRICO -->
    <div id="historyModal" class="hidden fixed inset-0 z-[9999] bg-[#F8FAFC] overflow-y-auto w-full h-full">
        <div class="max-w-md mx-auto p-6 min-h-screen">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold text-brand flex items-center gap-2 m-0">
                    <i class="fa-solid fa-clock-rotate-left text-detail"></i> Histórico
                </h2>
                <button type="button" onclick="fecharHistorico()" class="bg-white hover:bg-slate-50 rounded-full p-2 w-10 h-10 flex items-center justify-center transition-colors shadow-sm border border-slate-100">
                    <i class="fa-solid fa-xmark text-slate-500"></i>
                </button>
            </div>
            <div id="historyList" class="space-y-4"></div>
            <div class="mt-8 text-center text-slate-400 text-xs pb-10">Armazenado no navegador deste celular.</div>
        </div>
    </div>

    <!-- WRAPPER PDF -->
    <div id="pdf-wrapper">
        <div id="pdf-template">
            <div style="width: 100%; font-family: 'Poppins', sans-serif; color: #0F172A; background: white; padding: 40px; box-sizing: border-box;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; border-bottom: 3px solid #0F172A; padding-bottom: 20px;">
                    <div>
                        <div style="font-size: 28px; font-weight: 800; color: #0F172A; letter-spacing: -0.5px;" id="pdfHeaderCompany">
                            GESSO<span style="color: #2563EB;">MASTER</span>
                        </div>
                        <div style="font-size: 14px; color: #64748B; margin-top: 5px;">Soluções Especializadas em Drywall e Gesso</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 32px; font-weight: bold; color: #0F172A;">ORÇAMENTO</div>
                        <div style="font-size: 14px; color: #64748B;">Data: <span id="pdfDate"></span></div>
                        <div style="font-size: 14px; color: #64748B;">Ref: #<span id="pdfId"></span></div>
                    </div>
                </div>
                <div style="display: flex; gap: 40px; margin-bottom: 40px;">
                    <div style="flex: 1;">
                        <h3 style="font-size: 12px; text-transform: uppercase; color: #94A3B8; font-weight: 700; margin-bottom: 10px;">Informações do Cliente</h3>
                        <div style="background: #F8FAFC; padding: 15px; border-radius: 8px; border: 1px solid #E2E8F0;">
                            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;" id="pdfClientName"></div>
                            <div style="color: #475569; font-size: 14px; margin-bottom: 3px;" id="pdfClientPhone"></div>
                            <div style="color: #475569; font-size: 14px;" id="pdfClientAddress"></div>
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <h3 style="font-size: 12px; text-transform: uppercase; color: #94A3B8; font-weight: 700; margin-bottom: 10px;">Resumo do Projeto</h3>
                        <div style="background: #F1F5F9; padding: 15px; border-radius: 8px; border: 1px solid #E2E8F0;">
                            <div id="pdfProjectSummary" style="color: #334155; font-size: 14px;">Este orçamento inclui fornecimento de material e mão de obra especializada.</div>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 40px;">
                    <h3 style="font-size: 16px; font-weight: 700; color: #0F172A; margin-bottom: 15px; border-left: 4px solid #0F172A; padding-left: 10px;">Detalhamento dos Serviços</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: #F1F5F9; color: #334155;">
                                <th style="padding: 12px 15px; text-align: left; border-radius: 6px 0 0 6px;">Descrição do Serviço</th>
                                <th style="padding: 12px 15px; text-align: center;">Qtd/Medida</th>
                                <th style="padding: 12px 15px; text-align: right; border-radius: 0 6px 6px 0;">Valor Estimado</th>
                            </tr>
                        </thead>
                        <tbody id="pdfServicesTableBody"></tbody>
                        <tfoot id="pdfServicesTableFoot">
                             <!-- Footer Injetado via JS -->
                        </tfoot>
                    </table>
                </div>
                <div style="margin-top: 60px; display: flex; gap: 40px; align-items: flex-end; page-break-inside: avoid;">
                    <div style="flex: 1; text-align: center;">
                        <div style="border-bottom: 1px solid #000; margin-bottom: 10px;"></div>
                        <div style="font-size: 12px; font-weight: bold;">Responsável Técnico</div>
                        <div style="font-size: 11px; color: #666;" id="pdfFooterCompany">GessoMaster</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="border-bottom: 1px solid #000; margin-bottom: 10px;"></div>
                        <div style="font-size: 12px; font-weight: bold;">Cliente</div>
                        <div style="font-size: 11px; color: #666;">Aprovação</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- SCRIPTS LÓGICOS -->
<script>
    // TOAST & MODAL SYSTEM
    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `custom-toast ${isError ? 'error' : ''}`;
        toast.innerHTML = `<i class="fa-solid ${isError ? 'fa-circle-exclamation' : 'fa-circle-check'}"></i> <span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(-20px)';
            toast.style.transition = 'all 0.3s';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function showConfirm(message, onConfirm) {
        const overlay = document.getElementById('confirm-modal-overlay');
        const text = document.getElementById('confirm-modal-text');
        const btnConfirm = document.getElementById('btn-confirm-modal');
        const btnCancel = document.getElementById('btn-cancel-modal');

        text.innerText = message;
        overlay.classList.add('active');

        // Cleanup old listeners to prevent multiple firings
        const newBtnConfirm = btnConfirm.cloneNode(true);
        const newBtnCancel = btnCancel.cloneNode(true);
        btnConfirm.parentNode.replaceChild(newBtnConfirm, btnConfirm);
        btnCancel.parentNode.replaceChild(newBtnCancel, btnCancel);

        newBtnConfirm.addEventListener('click', () => {
            overlay.classList.remove('active');
            if (onConfirm) onConfirm();
        });

        newBtnCancel.addEventListener('click', () => {
            overlay.classList.remove('active');
        });
    }

    // LOGO UPLOAD SYSTEM
    let tempLogoBase64 = null;

    function handleLogoUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                tempLogoBase64 = e.target.result;
                // Update preview
                const preview = document.getElementById('logoPreview');
                preview.innerHTML = `<img src="${tempLogoBase64}" class="w-full h-full object-contain">`;
                document.getElementById('btnRemoveLogo').classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function removerLogo() {
        tempLogoBase64 = null;
        const preview = document.getElementById('logoPreview');
        preview.innerHTML = `<i class="fa-regular fa-image text-slate-300 text-xl"></i>`;
        document.getElementById('btnRemoveLogo').classList.add('hidden');
        document.getElementById('companyLogoInput').value = ''; // Reset input
    }

    // MATERIAIS MODAL
    function abrirMateriais() {
        if(!calculationResult || !calculationResult.materialList) {
            showToast("Calcule um orçamento primeiro.", true);
            return;
        }
        
        const listBody = document.getElementById('materials-list-body');
        listBody.innerHTML = '';

        if(Object.keys(calculationResult.materialList).length === 0) {
            listBody.innerHTML = '<div class="text-center text-slate-400 py-6">Nenhum material estimado para os serviços selecionados.</div>';
        } else {
            for (const [name, data] of Object.entries(calculationResult.materialList)) {
                listBody.innerHTML += `
                    <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <span class="text-slate-700 font-medium text-sm w-2/3">${name}</span>
                        <span class="text-brand font-bold text-sm bg-white px-2 py-1 rounded border border-slate-200">${Math.ceil(data.qtd)} ${data.unit}</span>
                    </div>
                `;
            }
        }
        
        document.getElementById('materials-modal-overlay').classList.add('active');
    }

    function fecharMateriais() {
        document.getElementById('materials-modal-overlay').classList.remove('active');
    }

    function copiarMateriais() {
        if(!calculationResult || !calculationResult.materialList) return;
        let text = "*Lista de Materiais Estimada (GessoMaster):*\n\n";
        for (const [name, data] of Object.entries(calculationResult.materialList)) {
            text += `- ${name}: ${Math.ceil(data.qtd)} ${data.unit}\n`;
        }
        text += "\n_Nota: Valores aproximados considerando perda média._";
        
        navigator.clipboard.writeText(text).then(() => {
            showToast("Lista copiada!");
            fecharMateriais();
        }).catch(err => {
            showToast("Erro ao copiar.", true);
        });
    }

    // LÓGICA DE ESTIMATIVA DE MATERIAIS
    const MATERIAL_RECIPES = {
        'Forro Plaquinha Dilatado': (area) => [
            { name: 'Placa 60x60', qtd: (area / 0.36) * 1.05, unit: 'un' },
            { name: 'Gesso em Pó (Saco 40kg)', qtd: area / 15, unit: 'sc' },
            { name: 'Sisal', qtd: area * 0.05, unit: 'kg' },
            { name: 'Arame Galvanizado', qtd: area * 0.12, unit: 'kg' },
            { name: 'Junta de Dilatação (Tabica)', qtd: Math.sqrt(area) * 4, unit: 'm' }
        ],
        'Forro Drywall': (area) => [
            { name: 'Chapa Drywall ST (1.20x2.40)', qtd: (area / 2.88) * 1.05, unit: 'un' },
            { name: 'Perfil F530', qtd: area * 2.5, unit: 'm' }, 
            { name: 'Canaleta/Tabica (Perímetro Est.)', qtd: Math.sqrt(area) * 4, unit: 'm' }, 
            { name: 'Parafuso GN25', qtd: area * 30, unit: 'un' },
            { name: 'Parafuso Metal x Metal', qtd: area * 4, unit: 'un' },
            { name: 'Fita de Papel', qtd: area * 2, unit: 'm' },
            { name: 'Massa de Junta', qtd: area * 0.6, unit: 'kg' },
            { name: 'Arame/Tirante', qtd: area * 1.5, unit: 'un' }
        ],
        'Forro Plaquinha': (area) => [
            { name: 'Placa 60x60', qtd: (area / 0.36) * 1.05, unit: 'un' },
            { name: 'Gesso em Pó (Saco 40kg)', qtd: area / 15, unit: 'sc' },
            { name: 'Sisal', qtd: area * 0.05, unit: 'kg' },
            { name: 'Arame Galvanizado', qtd: area * 0.12, unit: 'kg' },
            { name: 'Junta de Dilatação (Estimativa)', qtd: Math.sqrt(area) * 4, unit: 'm' }
        ],
        'Parede Drywall': (area) => [
             { name: 'Chapa Drywall ST (1.20x2.40)', qtd: ((area * 2) / 2.88) * 1.05, unit: 'un' },
             { name: 'Montante 48/70/90', qtd: area * 2.2, unit: 'm' },
             { name: 'Guia 48/70/90', qtd: Math.sqrt(area) * 2, unit: 'm' },
             { name: 'Parafuso GN25', qtd: area * 30, unit: 'un' },
             { name: 'Fita de Papel', qtd: area * 3, unit: 'm' }, 
             { name: 'Massa de Junta', qtd: area * 0.9, unit: 'kg' },
             { name: 'Banda Acústica (Opcional)', qtd: Math.sqrt(area) * 2, unit: 'm' }
        ],
        'Revestimento de Parede': (area) => [
             { name: 'Placa 60x60', qtd: (area / 0.36) * 1.05, unit: 'un' },
             { name: 'Gesso Cola', qtd: area * 1.5, unit: 'kg' }, 
        ],
        'Revestimento Drywall': (area) => [
             { name: 'Chapa Drywall ST (1.20x2.40)', qtd: (area / 2.88) * 1.05, unit: 'un' },
             { name: 'Gesso Cola', qtd: area * 2.5, unit: 'kg' }, 
             { name: 'Massa de Junta', qtd: area * 0.4, unit: 'kg' },
             { name: 'Fita de Papel', qtd: area * 1.5, unit: 'm' }
        ],
        'Forro PVC': (area) => [
            { name: 'Lâminas de PVC', qtd: area * 1.05, unit: 'm²' },
            { name: 'Perfil Metalom 15x15 (Estrutura)', qtd: area * 3, unit: 'm' }, 
            { name: 'Acabamento (Meia Cana/Moldura)', qtd: Math.sqrt(area) * 4, unit: 'm' },
            { name: 'Parafusos/Fixadores', qtd: area * 10, unit: 'un' },
            { name: 'Arame/Suspensão', qtd: area * 1.5, unit: 'un' }
        ]
    };

    // VERSÃO DO APP
    const APP_VERSION = '2.0';

    let services = [];
    let calculationResult = null;
    const formatMoney = (value) => {
        if(typeof value !== 'number' || isNaN(value)) return 'R$ 0,00';
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };

    function safeLoadPreferences() {
        try { loadPreferences(); } catch (e) { console.error("Erro prefs", e); }
        // Exibir versão
        const vDisplay = document.getElementById('appVersionDisplay');
        if(vDisplay) vDisplay.innerText = APP_VERSION;
    }

    // --- ATUALIZAÇÃO ---
    function verificarAtualizacao() {
        showConfirm('Isso irá recarregar o aplicativo para buscar a versão mais recente do site. Deseja continuar?', () => {
            // Truque de cache busting
            const novaUrl = window.location.pathname + '?update=' + new Date().getTime();
            window.location.href = novaUrl;
        });
    }

    // --- NAVEGAÇÃO ---
    function mostrarResultados() { document.getElementById('appContainer').classList.add('hidden'); document.getElementById('resultsDashboard').classList.remove('hidden'); window.scrollTo(0,0); document.body.classList.add('no-scroll'); }
    function fecharResultados() { document.getElementById('resultsDashboard').classList.add('hidden'); document.getElementById('appContainer').classList.remove('hidden'); document.body.classList.remove('no-scroll'); }
    function abrirHistorico() { document.getElementById('appContainer').classList.add('hidden'); document.getElementById('historyModal').classList.remove('hidden'); carregarListaHistorico(); window.scrollTo(0,0); document.body.classList.add('no-scroll'); }
    function fecharHistorico() { document.getElementById('historyModal').classList.add('hidden'); document.getElementById('appContainer').classList.remove('hidden'); document.body.classList.remove('no-scroll'); }
    function abrirConfig() { document.getElementById('appContainer').classList.add('hidden'); document.getElementById('configModal').classList.remove('hidden'); window.scrollTo(0,0); document.body.classList.add('no-scroll'); }
    function fecharConfig() { document.getElementById('configModal').classList.add('hidden'); document.getElementById('appContainer').classList.remove('hidden'); document.body.classList.remove('no-scroll'); }

    // --- PREÇOS ---
    function initPriceTable() {
        const select = document.getElementById('serviceTypeInput');
        if(!select) return;
        const tableContainer = document.getElementById('servicePriceTable');
        if(!tableContainer) return;
        
        tableContainer.innerHTML = '';
        select.querySelectorAll('option').forEach(opt => {
            if(opt.value) {
                const inputId = 'price_svc_' + opt.value.replace(/\s+/g, '_');
                const row = document.createElement('div');
                row.className = 'flex justify-between items-center bg-white p-2.5 rounded-lg border border-slate-100 shadow-sm';
                
                let deleteBtn = '';
                // Verifica se o option pertence ao grupo de customizados
                if(opt.parentElement && opt.parentElement.id === 'customServicesOptGroup') {
                    deleteBtn = `<button onclick="deletarServicoCustomizado('${opt.value}')" class="ml-2 text-red-400 hover:text-red-600 p-1.5"><i class="fa-solid fa-trash-can text-xs"></i></button>`;
                }

                row.innerHTML = `
                    <div class="flex items-center w-2/3 gap-2">
                        <label class="text-xs text-slate-600 font-bold truncate flex-1">${opt.text}</label>
                    </div>
                    <div class="flex items-center">
                        <input type="number" id="${inputId}" placeholder="0.00" class="bg-slate-50 text-slate-800 font-mono text-xs p-1.5 rounded border border-slate-200 w-20 text-right focus:outline-none focus:border-slate-800" onchange="savePreferences()">
                        ${deleteBtn}
                    </div>`;
                tableContainer.appendChild(row);
            }
        });
    }

    // --- SERVIÇOS CUSTOMIZADOS (NOVO) ---
    function renderCustomServices() {
        const optGroup = document.getElementById('customServicesOptGroup');
        if (!optGroup) return;
        optGroup.innerHTML = '';
        
        const prefs = JSON.parse(localStorage.getItem('gessoMasterPrefs') || '{}');
        const list = prefs.customServices || [];
        
        list.forEach(svc => {
            const option = document.createElement('option');
            option.value = svc.name;
            option.text = svc.name;
            option.dataset.unit = svc.unit;
            optGroup.appendChild(option);
        });
    }

    function adicionarServicoCustomizado() {
        const name = document.getElementById('newServiceName').value.trim();
        const unit = document.getElementById('newServiceUnit').value;
        const price = parseFloat(document.getElementById('newServicePrice').value);

        if(!name) { showToast("Nome do serviço é obrigatório", true); return; }
        
        const prefs = JSON.parse(localStorage.getItem('gessoMasterPrefs') || '{}');
        if(!prefs.customServices) prefs.customServices = [];
        
        if(prefs.customServices.some(s => s.name === name)) {
            showToast("Este serviço já existe", true); return;
        }

        prefs.customServices.push({ name, unit });
        
        if(!prefs.servicePrices) prefs.servicePrices = {};
        if(!isNaN(price) && price > 0) prefs.servicePrices[name] = price;

        localStorage.setItem('gessoMasterPrefs', JSON.stringify(prefs));
        
        renderCustomServices();
        initPriceTable();
        
        document.getElementById('newServiceName').value = '';
        document.getElementById('newServicePrice').value = '';
        showToast("Serviço salvo com sucesso!");
    }

    function deletarServicoCustomizado(name) {
        showConfirm(`Deseja excluir o serviço "${name}"?`, () => {
            const prefs = JSON.parse(localStorage.getItem('gessoMasterPrefs') || '{}');
            if(prefs.customServices) {
                prefs.customServices = prefs.customServices.filter(s => s.name !== name);
                localStorage.setItem('gessoMasterPrefs', JSON.stringify(prefs));
                renderCustomServices();
                initPriceTable();
                showToast("Serviço excluído.");
            }
        });
    }

    // --- LÓGICA DE UNIDADES (NOVO) ---
    const defaultUnits = {
        'Moldura de Gesso': 'm',
        'Sanca Aberta Gesso': 'm',
        'Sanca Fechada Gesso': 'm',
        'Cortineiro Gesso': 'm',
        'Sanca Ilha': 'm',
        'Sanca Invertida': 'm',
        'Rasgo de Luz': 'm',
        'Cortineiro Embutido': 'm',
        'Cortineiro Sobreposto': 'm',
        'Boiserie': 'm',
        'Rodateto Decorado': 'm',
        'Nicho Embutido': 'un',
        'Sanca de PVC': 'm',
        // O restante assume m²
    };

    const serviceSelect = document.getElementById('serviceTypeInput');
    const unitSelect = document.getElementById('unitInput');
    
    if(serviceSelect && unitSelect) {
        serviceSelect.addEventListener('change', function() {
            const val = this.value;
            const selectedOption = this.options[this.selectedIndex];
            const unit = selectedOption.dataset.unit || defaultUnits[val] || 'm²';
            unitSelect.value = unit;
        });
    }

    // --- PERSISTÊNCIA ---
    function savePreferences() {
        const servicePrices = {};
        const select = document.getElementById('serviceTypeInput');
        if(select) {
            select.querySelectorAll('option').forEach(opt => {
                if(opt.value) {
                    const inputId = 'price_svc_' + opt.value.replace(/\s+/g, '_');
                    const el = document.getElementById(inputId);
                    if(el && el.value) servicePrices[opt.value] = el.value;
                }
            });
        }
        
        const currentPrefs = JSON.parse(localStorage.getItem('gessoMasterPrefs') || '{}');
        
        const preferences = {
            ...currentPrefs, 
            companyName: document.getElementById('companyName').value,
            profitMargin: document.getElementById('profitMargin').value,
            servicePrices: servicePrices,
            sheet: document.getElementById('priceSheet').value,
            profile: document.getElementById('priceProfile').value,
            screw: document.getElementById('priceScrew').value,
            compound: document.getElementById('priceCompound').value,
            companyLogo: tempLogoBase64 // Save the base64 string for logo
        };
        const mainTotalExtra = document.getElementById('totalExtraCost');
        if(mainTotalExtra) preferences.totalExtraCost = mainTotalExtra.value;

        localStorage.setItem('gessoMasterPrefs', JSON.stringify(preferences));
        showToast("Configurações salvas!");
    }

    function loadPreferences() {
        renderCustomServices();
        initPriceTable();
        const prefs = JSON.parse(localStorage.getItem('gessoMasterPrefs'));

        if(prefs) {
            if(prefs.companyName) document.getElementById('companyName').value = prefs.companyName;
            if(prefs.totalExtraCost && document.getElementById('totalExtraCost')) document.getElementById('totalExtraCost').value = prefs.totalExtraCost;
            if(prefs.profitMargin) {
                document.getElementById('profitMargin').value = prefs.profitMargin;
                document.getElementById('profitDisplayConfig').innerText = prefs.profitMargin + '%';
            }
            if(prefs.servicePrices) {
                for (const [key, value] of Object.entries(prefs.servicePrices)) {
                    const inputId = 'price_svc_' + key.replace(/\s+/g, '_');
                    const el = document.getElementById(inputId);
                    if(el) el.value = value;
                }
            }
            // Load Logo
            if (prefs.companyLogo) {
                tempLogoBase64 = prefs.companyLogo;
                const preview = document.getElementById('logoPreview');
                preview.innerHTML = `<img src="${prefs.companyLogo}" class="w-full h-full object-contain">`;
                document.getElementById('btnRemoveLogo').classList.remove('hidden');
            }
        }
    }

    function carregarListaHistorico() {
        try {
            const list = document.getElementById('historyList'); list.innerHTML = '';
            const history = JSON.parse(localStorage.getItem('gessoMasterHistory') || '[]');
            if (history.length === 0) { list.innerHTML = '<div class="text-center text-slate-400 py-10">Nenhum orçamento salvo.</div>'; return; }
            history.sort((a, b) => b.timestamp - a.timestamp);
            history.forEach(item => {
                const date = new Date(item.timestamp).toLocaleDateString('pt-BR');
                list.innerHTML += `<div class="clean-card p-4 flex justify-between items-center border-l-4 border-brand mb-3"><div><div class="text-brand font-bold text-sm">${item.data.clientName}</div><div class="text-xs text-slate-400">${date}</div><div class="text-detail font-bold mt-1">${formatMoney(item.data.salePrice)}</div></div><div class="flex gap-2"><button type="button" onclick="carregarHistorico(${item.id})" class="bg-blue-50 text-detail p-2 rounded-lg hover:bg-blue-100"><i class="fa-solid fa-eye"></i></button><button type="button" onclick="excluirHistorico(${item.id})" class="bg-red-50 text-red-500 p-2 rounded-lg hover:bg-red-100"><i class="fa-solid fa-trash"></i></button></div></div>`;
            });
        } catch(e) { localStorage.removeItem('gessoMasterHistory'); }
    }

    function salvarOrcamentoAtual() {
        if (!calculationResult) return;
        const history = JSON.parse(localStorage.getItem('gessoMasterHistory') || '[]');
        history.push({ id: Date.now(), timestamp: Date.now(), data: calculationResult });
        localStorage.setItem('gessoMasterHistory', JSON.stringify(history));
    }

    function excluirHistorico(id) {
        showConfirm("Tem certeza que deseja excluir este orçamento?", () => {
            let history = JSON.parse(localStorage.getItem('gessoMasterHistory') || '[]');
            history = history.filter(item => item.id !== id);
            localStorage.setItem('gessoMasterHistory', JSON.stringify(history));
            carregarListaHistorico();
            showToast("Orçamento excluído.");
        });
    }

    function carregarHistorico(id) {
        const history = JSON.parse(localStorage.getItem('gessoMasterHistory') || '[]');
        const item = history.find(i => i.id === id);
        if (item) {
            calculationResult = item.data;
            services = item.data.servicesDetail || [];
            document.getElementById('clientName').value = item.data.clientName || '';
            document.getElementById('clientPhone').value = item.data.clientPhone || '';
            document.getElementById('clientAddress').value = item.data.clientAddress || '';
            const totalCostReal = (item.data.salePrice || 0) - (item.data.netProfit || 0);
            const extraCostInput = document.getElementById('totalExtraCost');
            if(extraCostInput) extraCostInput.value = totalCostReal > 0 ? totalCostReal : '';
            renderServicesList();
            document.getElementById('displayClientPrice').innerText = formatMoney(calculationResult.salePrice);
            document.getElementById('displayProfit').innerText = formatMoney(calculationResult.netProfit);
            document.getElementById('detailSale').innerText = formatMoney(calculationResult.salePrice);
            document.getElementById('detailCost').innerText = formatMoney(totalCostReal);
            document.getElementById('detailProfitFinal').innerText = formatMoney(calculationResult.netProfit);
            document.getElementById('historyModal').classList.add('hidden');
            mostrarResultados();
            showToast("Orçamento carregado!");
        }
    }

    function toggleServiceTab(tab) {
        const blockCatalogo = document.getElementById('blockCatalogo');
        const blockCustom = document.getElementById('blockCustom');
        const tabCatalogo = document.getElementById('tabCatalogo');
        const tabCustom = document.getElementById('tabCustom');
        if(tab === 'catalogo') {
            blockCatalogo.classList.remove('hidden'); blockCustom.classList.add('hidden');
            tabCatalogo.classList.add('text-brand', 'border-brand'); tabCatalogo.classList.remove('text-slate-400', 'border-transparent');
            tabCustom.classList.add('text-slate-400', 'border-transparent'); tabCustom.classList.remove('text-brand', 'border-brand');
        } else {
            blockCatalogo.classList.add('hidden'); blockCustom.classList.remove('hidden');
            tabCatalogo.classList.add('text-slate-400', 'border-transparent'); tabCatalogo.classList.remove('text-brand', 'border-brand');
            tabCustom.classList.add('text-brand', 'border-brand'); tabCustom.classList.remove('text-slate-400', 'border-transparent');
        }
    }

    function adicionarServico() {
        const typeSelect = document.getElementById('serviceTypeInput');
        const areaInput = document.getElementById('areaInput');
        const customRateInput = document.getElementById('customRateInput');
        const unitInput = document.getElementById('unitInput'); // Captura Unidade
        
        const type = typeSelect.value;
        const text = typeSelect.options[typeSelect.selectedIndex].text;
        const area = parseFloat(areaInput.value);
        const customRate = parseFloat(customRateInput.value);
        const unit = unitInput.value || 'm²'; // Padrão m²
        
        if (!area || area <= 0) { showToast("Quantidade/Metragem inválida.", true); return; }
        
        const hasCustomRate = !isNaN(customRate) && customRate > 0;
        
        services.push({ 
            id: Date.now(), 
            type, 
            typeText: text, 
            area, 
            unit, // Salva unidade
            isCustom: false, 
            customRate: hasCustomRate ? customRate : null 
        });
        
        areaInput.value = ''; customRateInput.value = ''; areaInput.focus(); renderServicesList();
        showToast("Item adicionado!");
    }

    function adicionarPersonalizado() {
        const name = document.getElementById('customNameInput').value.trim();
        const price = parseFloat(document.getElementById('customPriceInput').value);
        if (!name) { showToast("Nome inválido.", true); return; }
        if (isNaN(price) || price < 0) { showToast("Valor inválido.", true); return; }
        // Personalizados são tratados como 'verba' ou 'serviço', sem unidade específica de cálculo, mas podemos pôr 'vb' ou 'un' se quiser.
        services.push({ id: Date.now(), type: 'Personalizado', typeText: name, area: 1, unit: 'un', isCustom: true, fixedPrice: price });
        document.getElementById('customNameInput').value = ''; document.getElementById('customPriceInput').value = '';
        document.getElementById('customNameInput').focus(); renderServicesList();
        showToast("Item avulso adicionado!");
    }

    function editarServico(id) {
        const item = services.find(s => s.id === id);
        if (!item) return;

        if (item.isCustom) {
            toggleServiceTab('custom');
            document.getElementById('customNameInput').value = item.typeText;
            document.getElementById('customPriceInput').value = item.fixedPrice;
            document.getElementById('customNameInput').focus();
        } else {
            toggleServiceTab('catalogo');
            const select = document.getElementById('serviceTypeInput');
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === item.type) {
                    select.selectedIndex = i;
                    break;
                }
            }
            document.getElementById('areaInput').value = item.area;
            document.getElementById('customRateInput').value = item.customRate || '';
            document.getElementById('unitInput').value = item.unit || 'm²'; // Restaura unidade
            document.getElementById('areaInput').focus();
        }
        removerServico(id);
    }

    function removerServico(id) { services = services.filter(s => s.id !== id); renderServicesList(); }

    function renderServicesList() {
        const list = document.getElementById('servicesList');
        const totalDisplay = document.getElementById('totalAreaDisplay');
        const container = document.getElementById('servicesListContainer');
        if (services.length === 0) { container.classList.add('hidden'); return; }
        container.classList.remove('hidden');
        list.innerHTML = '';
        let totalArea = 0, totalCustom = 0;
        const prefs = JSON.parse(localStorage.getItem('gessoMasterPrefs') || '{}');
        const servicePrices = prefs.servicePrices || {};

        services.forEach(item => {
            let displayValue = '', iconClass = '', borderClass = '';
            const storedPrice = servicePrices[item.type] ? parseFloat(servicePrices[item.type]) : 0;
            const unitLabel = item.unit || 'm²'; // Label para exibição

            if (item.isCustom) {
                displayValue = formatMoney(item.fixedPrice);
                iconClass = 'fa-pen-to-square text-detail bg-blue-50'; borderClass = 'border-blue-100'; totalCustom += item.fixedPrice;
            } else {
                totalArea += item.area;
                // Exibe a unidade correta (m², m, un)
                if(item.customRate) { 
                    displayValue = `${item.area} ${unitLabel} x ${formatMoney(item.customRate)}`; 
                    borderClass = 'border-slate-300'; iconClass = 'fa-tag text-slate-700 bg-slate-100'; 
                }
                else if (storedPrice > 0) { 
                    displayValue = `${item.area} ${unitLabel} x ${formatMoney(storedPrice)} (Tab)`; 
                    borderClass = 'border-slate-300'; iconClass = 'fa-table text-slate-700 bg-slate-100'; 
                }
                else { 
                    displayValue = `${item.area} ${unitLabel} (Calc)`; 
                    iconClass = 'fa-calculator text-slate-500 bg-slate-100'; borderClass = 'border-slate-200'; 
                }
            }
            list.innerHTML += `<div class="bg-white p-4 rounded-xl border ${borderClass} flex justify-between items-center group transition-all shadow-sm"><div class="flex items-center gap-4"><div class="${iconClass} w-10 h-10 rounded-full flex items-center justify-center text-sm"><i class="fa-solid ${item.isCustom ? 'fa-pen' : (item.customRate ? 'fa-tag' : (storedPrice > 0 ? 'fa-table' : 'fa-calculator'))}"></i></div><div><div class="text-slate-800 font-bold text-sm">${item.typeText}</div><div class="text-slate-400 text-xs mt-0.5"><span class="font-mono text-slate-500 font-bold">${displayValue}</span></div></div></div><div class="flex gap-2"><button onclick="editarServico(${item.id})" class="text-slate-400 hover:text-blue-600 bg-slate-50 hover:bg-blue-50 p-2 rounded-lg transition-all" title="Editar"><i class="fa-solid fa-pen"></i></button><button onclick="removerServico(${item.id})" class="text-slate-400 hover:text-red-500 bg-slate-50 hover:bg-red-50 p-2 rounded-lg transition-all" title="Remover"><i class="fa-solid fa-trash-can"></i></button></div></div>`;
        });
        totalDisplay.innerText = `Qtd Total: ${totalArea.toFixed(2)} | Extras: ${formatMoney(totalCustom)}`;
    }

    // --- CÁLCULO FINANCEIRO ---
    function calcularOrcamento() {
        if (services.length === 0) { showToast("Adicione um serviço.", true); return; }
        const companyName = document.getElementById('companyName').value || "GessoMaster";
        const prefs = JSON.parse(localStorage.getItem('gessoMasterPrefs') || '{}');
        const servicePrices = prefs.servicePrices || {};

        let drywallArea = 0, plaquinhaArea = 0, totalCalculatedPrice = 0, totalMaterialCost = 0;
        const totalExtraCost = parseFloat(document.getElementById('totalExtraCost').value) || 0;
        const marginPercent = parseFloat(document.getElementById('profitMargin').value) || 0;
        
        // --- MATERIAL ESTIMATION LOGIC ---
        const materialAggregator = {}; // { 'Chapa': { qtd: 10, unit: 'un' } }

        // Sort keys by length descending to ensure specific keys (like "Forro Plaquinha Dilatado") are found before generic ones ("Forro Plaquinha")
        const sortedRecipeKeys = Object.keys(MATERIAL_RECIPES).sort((a, b) => b.length - a.length);

        services.forEach(s => {
            // Price Calculation
            if(!s.isCustom) {
                const wetKeywords = ['Plaquinha', 'Aramado', 'Beiral', 'Gesso 3D', 'Moldura', 'Gesso', 'Boiserie', 'Rodateto'];
                const isWet = wetKeywords.some(keyword => s.typeText.includes(keyword) || s.type.includes(keyword));
                if(isWet) plaquinhaArea += s.area; else drywallArea += s.area;
            }

            // Material Estimation per service
            if (!s.isCustom) {
                let recipeKey = sortedRecipeKeys.find(key => s.type.includes(key));
                if (recipeKey) {
                    const materials = MATERIAL_RECIPES[recipeKey](s.area);
                    materials.forEach(mat => {
                        if (!materialAggregator[mat.name]) {
                            materialAggregator[mat.name] = { qtd: 0, unit: mat.unit };
                        }
                        materialAggregator[mat.name].qtd += mat.qtd;
                    });
                }
            }
        });

        // Simple cost estimation for internal profit logic (kept from previous version)
        const pricesDrywall = { sheet: 38.00, profile: 18.00, screw: 15.00, tape: 25.00, compound: 45.00 };
        const pricesPlaque = { plaque: 3.50, plaster: 28.00, wire: 18.00, sisal: 12.00 };

        let costMaterialsDrywall = 0, costMaterialsPlaque = 0;

        if(drywallArea > 0) {
            const qtdSheets = Math.ceil((drywallArea / 2.88) * 1.05); const qtdProfiles = Math.ceil((drywallArea * 2) / 3); const qtdScrewsPack = Math.ceil((drywallArea * 35) / 100); const qtdTapeRolls = Math.ceil((drywallArea * 2) / 90); const qtdCompoundBags = Math.ceil((drywallArea * 0.7) / 20);
            costMaterialsDrywall = (qtdSheets * pricesDrywall.sheet) + (qtdProfiles * pricesDrywall.profile) + (qtdScrewsPack * pricesDrywall.screw) + (qtdTapeRolls * pricesDrywall.tape) + (qtdCompoundBags * pricesDrywall.compound);
        }
        if(plaquinhaArea > 0) {
            const qtdPlaques = Math.ceil((plaquinhaArea / 0.36) * 1.05); const qtdPlasterBags = Math.ceil(plaquinhaArea / 15); const qtdWireKg = Math.ceil(plaquinhaArea * 0.12); const qtdSisalKg = Math.ceil(plaquinhaArea * 0.05);
            costMaterialsPlaque = (qtdPlaques * pricesPlaque.plaque) + (qtdPlasterBags * pricesPlaque.plaster) + (qtdWireKg * pricesPlaque.wire) + (qtdSisalKg * pricesPlaque.sisal);
        }
        totalMaterialCost = costMaterialsDrywall + costMaterialsPlaque;
        
        // Final Price Summation
        services.forEach(s => {
            let itemPrice = 0;
            if (s.isCustom) { itemPrice = s.fixedPrice; } 
            else if (s.customRate) { itemPrice = s.area * s.customRate; } 
            else if (servicePrices[s.type] && parseFloat(servicePrices[s.type]) > 0) { itemPrice = s.area * parseFloat(servicePrices[s.type]); } 
            else {
                const baseCost = s.area * 30; 
                itemPrice = baseCost + (baseCost * (marginPercent / 100));
            }
            totalCalculatedPrice += itemPrice;
        });

        const netProfit = totalCalculatedPrice - (totalExtraCost);

        calculationResult = {
            companyName, clientName: document.getElementById('clientName').value || "Cliente", clientPhone: document.getElementById('clientPhone').value, clientAddress: document.getElementById('clientAddress').value,
            totalArea: drywallArea + plaquinhaArea, 
            grossPrice: totalCalculatedPrice,
            salePrice: totalCalculatedPrice, 
            netProfit: netProfit,
            totalExpenses: totalExtraCost,
            discount: 0,
            materialList: materialAggregator, // Storing the list here
            servicesDetail: services.map(s => {
                let val = 0;
                if(s.isCustom) val = s.fixedPrice;
                else if(s.customRate) val = s.area * s.customRate;
                else if(servicePrices[s.type] && parseFloat(servicePrices[s.type]) > 0) val = s.area * parseFloat(servicePrices[s.type]);
                else { const baseCost = s.area * 30; val = baseCost + (baseCost * (marginPercent / 100)); }
                
                // Lógica de exibição da junta no orçamento removida a pedido
                
                return { ...s, typeText: s.typeText, estimatedValue: val };
            })
        };

        const elPrice = document.getElementById('displayClientPrice'); if(elPrice) elPrice.innerText = formatMoney(totalCalculatedPrice);
        const elProfit = document.getElementById('displayProfit'); if(elProfit) elProfit.innerText = formatMoney(netProfit);
        const elDetailSale = document.getElementById('detailSale'); if(elDetailSale) elDetailSale.innerText = formatMoney(totalCalculatedPrice);
        const elDetailCost = document.getElementById('detailCost'); if(elDetailCost) elDetailCost.innerText = formatMoney(totalExtraCost);
        const elProfitFinal = document.getElementById('detailProfitFinal'); if(elProfitFinal) elProfitFinal.innerText = formatMoney(netProfit);
        
        // Reset Discount
        document.getElementById('discountInput').value = '';
        document.getElementById('detailDiscount').classList.add('hidden');
        
        salvarOrcamentoAtual();
        mostrarResultados();
    }

    // --- NOVA FUNÇÃO DE DESCONTO ---
    function aplicarDesconto() {
        if(!calculationResult) return;
        
        const discountVal = parseFloat(document.getElementById('discountInput').value) || 0;
        
        calculationResult.discount = discountVal;
        calculationResult.salePrice = calculationResult.grossPrice - discountVal;
        
        // Recalcular Lucro (Lucro = Venda Final - Gastos)
        calculationResult.netProfit = calculationResult.salePrice - calculationResult.totalExpenses;
        
        // Atualizar UI
        document.getElementById('displayClientPrice').innerText = formatMoney(calculationResult.salePrice);
        document.getElementById('displayProfit').innerText = formatMoney(calculationResult.netProfit);
        document.getElementById('detailProfitFinal').innerText = formatMoney(calculationResult.netProfit);
        
        // Atualizar Lista Detalhada
        const discountLine = document.getElementById('detailDiscount');
        const discountValueEl = document.getElementById('detailDiscountValue');
        
        if(discountVal > 0) {
            discountLine.classList.remove('hidden');
            discountValueEl.innerText = '- ' + formatMoney(discountVal);
        } else {
            discountLine.classList.add('hidden');
        }
    }

    function enviarWhatsApp() {
        // ... existing whatsapp function ...
        if (!calculationResult) return;
        let phone = calculationResult.clientPhone.replace(/\D/g, ''); 
        const name = calculationResult.clientName;
        const company = calculationResult.companyName; 
        const total = formatMoney(calculationResult.salePrice);
        // Ajuste no WhatsApp para mostrar unidade
        const servicesList = calculationResult.servicesDetail.map(s => { 
            let details = s.isCustom ? '(Extra)' : `(${s.area} ${s.unit || 'm²'})`; 
            return `• ${s.typeText} ${details}`; 
        }).join('\n');
        
        let discountMsg = "";
        if(calculationResult.discount > 0) {
            discountMsg = `\n(Desconto aplicado: -${formatMoney(calculationResult.discount)})`;
        }
        
        const message = `Olá, *${name}*! Tudo bem? 👋\n\nAqui é da *${company}*.\nConforme conversamos, segue o resumo do seu orçamento:\n\n${servicesList}\n\n💰 *Valor Total: ${total}*${discountMsg}\n\nPodemos agendar o início da obra?\nFico à disposição para tirar qualquer dúvida!`;
        if (phone) { 
            if (phone.length >= 10 && phone.length <= 11 && !phone.startsWith('55')) phone = '55' + phone; 
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank'); 
        }
        else { showToast("Número de telefone incompleto.", true); window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank'); }
    }

    function gerarPDF() {
        if (!calculationResult) return;
        const d = new Date();
        document.getElementById('pdfDate').innerText = d.toLocaleDateString('pt-BR');
        document.getElementById('pdfId').innerText = Math.floor(Math.random() * 9000) + 1000;
        const companyName = calculationResult.companyName;
        
        // READ CURRENT PREFS FOR LOGO (to ensure latest logo is used)
        const prefs = JSON.parse(localStorage.getItem('gessoMasterPrefs') || '{}');
        const logoBase64 = prefs.companyLogo;

        // Header Logic with Logo Support
        const headerEl = document.getElementById('pdfHeaderCompany');
        
        let companyNameHtml = 'GESSO<span style="color: #2563EB;">MASTER</span>';
        if(companyName && companyName !== "GessoMaster") { 
            companyNameHtml = `<span style="text-transform: uppercase;">${companyName}</span>`; 
        }

        if (logoBase64) {
            // Display Logo AND Name side by side
            headerEl.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="${logoBase64}" style="height: 50px; width: auto; object-fit: contain;">
                    <span>${companyNameHtml}</span>
                </div>`;
        } else {
            // Display only Name
            headerEl.innerHTML = companyNameHtml;
        }
        
        // Footer name always text
        document.getElementById('pdfFooterCompany').innerText = companyName && companyName !== "GessoMaster" ? companyName : 'GessoMaster';

        document.getElementById('pdfClientName').innerText = calculationResult.clientName;
        document.getElementById('pdfClientPhone').innerText = calculationResult.clientPhone || "Não informado";
        document.getElementById('pdfClientAddress').innerText = calculationResult.clientAddress || "Não informado";
        const tbody = document.getElementById('pdfServicesTableBody'); tbody.innerHTML = '';
        
        // Get custom summary or default
        const customSummary = document.getElementById('projectSummaryInput').value.trim();
        const defaultSummary = "Este orçamento inclui fornecimento de material e mão de obra especializada.";
        document.getElementById('pdfProjectSummary').innerText = customSummary || defaultSummary;

        calculationResult.servicesDetail.forEach((s) => {
            // Ajuste no PDF para mostrar unidade
            const areaDisplay = s.isCustom ? '-' : `${s.area} ${s.unit || 'm²'}`;
            tbody.innerHTML += `<tr style="border-bottom: 1px solid #e5e7eb; page-break-inside: avoid;"><td style="padding: 12px 15px; color: #374151;">${s.typeText || s.type}</td><td style="padding: 12px 15px; text-align: center; color: #6b7280;">${areaDisplay}</td><td style="padding: 12px 15px; text-align: right; color: #111827; font-weight: 500;">${formatMoney(s.estimatedValue)}</td></tr>`;
        });
        
        // FOOTER DINAMICO PARA DESCONTO
        const tfoot = document.getElementById('pdfServicesTableFoot');
        if(calculationResult.discount > 0) {
            tfoot.innerHTML = `
                <tr style="border-top: 2px solid #E2E8F0;">
                    <td colspan="2" style="padding: 10px 15px; text-align: right; color: #64748B;">Subtotal:</td>
                    <td style="padding: 10px 15px; text-align: right; color: #64748B;">${formatMoney(calculationResult.grossPrice)}</td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 5px 15px; text-align: right; color: #F97316;">Desconto:</td>
                    <td style="padding: 5px 15px; text-align: right; color: #F97316;">- ${formatMoney(calculationResult.discount)}</td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 15px; text-align: right; font-weight: bold; color: #334155;">TOTAL GERAL:</td>
                    <td style="padding: 15px; text-align: right; font-weight: 800; font-size: 20px; color: #0F172A;">${formatMoney(calculationResult.salePrice)}</td>
                </tr>
            `;
        } else {
             tfoot.innerHTML = `
                <tr style="border-top: 2px solid #E2E8F0;">
                    <td colspan="2" style="padding: 15px; text-align: right; font-weight: bold; color: #334155;">TOTAL GERAL DO SERVIÇO:</td>
                    <td style="padding: 15px; text-align: right; font-weight: 800; font-size: 20px; color: #0F172A;">${formatMoney(calculationResult.salePrice)}</td>
                </tr>
             `;
        }
        
        const element = document.getElementById('pdf-template'); const wrapper = document.getElementById('pdf-wrapper');
        wrapper.style.zIndex = "9999"; wrapper.style.height = "auto"; wrapper.style.overflow = "visible"; wrapper.style.backgroundColor = "white"; 
        const opt = { margin: 0, filename: `Orcamento_${calculationResult.clientName.replace(/\s+/g, '_')}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(element).save().then(() => { wrapper.style.zIndex = "-100"; wrapper.style.height = "0"; wrapper.style.overflow = "hidden"; });
    }
    
    // Iniciar
    safeLoadPreferences();
</script>